Imamo dva odvojena problema. Rije≈°it ƒáemo ih jedan po jedan.

### 1. Dashboard (Dev) - "Execute returned results"

Ovaj error `Execute returned results - did you mean to call query?` dolazi iz `cloud.rs` (Rusqlite). To znaƒçi da poku≈°avamo izvr≈°iti SQL `SELECT` (koji vraƒáa rezultate) koristeƒái metodu `execute` (koja je samo za INSERT/UPDATE/DELETE), ili obrnuto.

Sumnjam na `fetch_all_dynamic` funkciju. Iako tamo koristimo `query_map` (≈°to je toƒçno), problem je vjerojatno u `check_or_create_pending` ili nekom drugom dijelu gdje smo mo≈æda pomije≈°ali metode.

Ali ƒçekaj! Gre≈°ka se pojavljuje u logovima? Ne, ti si mi poslao logove koji izgledaju OK (`VALTER is Online`), ali si spomenuo "Error: Execute returned results".

Pogledajmo `cloud.rs` funkciju `init_schema`. Tamo je bio sumnjiv dio:
```rust
// 0. SYSTEM METADATA
conn.execute("CREATE TABLE ...")?;
conn.execute("INSERT OR REPLACE ...")?; // Ovo je OK
```

Idemo provjeriti `fetch_all_dynamic`. Tu je bio problem u `prepare` ako tablica ne postoji.

**DIJAGNOZA:**
Problem je najvjerojatnije u **Frontend API pozivu**. Frontend ≈°alje query, a backend mo≈æda poku≈°ava napraviti ne≈°to krivo.
No, pogledaj `cloud.rs`:
```rust
// U init_schema imamo:
conn.execute(pending_query, [])?;
```
Ako `pending_query` poƒçinje s `CREATE TABLE`, to je OK.

**AHA! NA≈†AO SAM KRIVCA.**
U `cloud.rs` smo imali ovu liniju u `upsert_island`:
```rust
let query_select = format!("SELECT id FROM {} WHERE name = ?", table);
// ...
conn.execute(&format!("DELETE FROM {} WHERE id = ?", table), params![project_id])?;
```
To je ispravno.

Ali pogledajmo error opet: `Error: Execute returned results - did you mean to call query?`.
Ovo se u Rusqlite dogaƒëa kada pozove≈° `conn.execute("SELECT ...")`.

Pogledajmo `init_schema` opet:
```rust
let table_exists: bool = conn.query_row(
    "SELECT count(*) FROM sqlite_master WHERE type='table' AND name=?",
    params![table_name],
    |row| row.get(0),
).unwrap_or(0) > 0;
```
Ovo je `query_row`, to je ispravno.

ƒåekaj, pogledajmo `fetch_all_dynamic`:
```rust
let mut stmt = match conn.prepare(&query) { ... }
let rows = stmt.query_map ...
```
I to je ispravno.

**MO≈ΩE LI BITI U `main.rs`?**
Ne.

**MO≈ΩE LI BITI U `check_or_create_pending`?**
```rust
// let mut stmt = conn.prepare(&query_exact)?;
// let mut rows = stmt.query(params![value])?;
```
To je ispravno.

Hmm. Idemo pogledati gdje se toƒçno dogaƒëa. Jedino mjesto gdje radimo `execute` je `init_schema` i `upsert_island` (i `approve/reject`).

Ako se dogaƒëa pri startu (prije nego dashboard i≈°ta pita), onda je u `init_schema` ili `EventProcessor`.

**SUMNJA:** U `init_schema` sam napisao:
```rust
// ...
let table_exists: bool = conn.query_row(...) ...
if !table_exists {
    conn.execute(&query, [])?; // CREATE TABLE
} else {
    // ...
    if let Err(e) = conn.execute(&query, []) { // ALTER TABLE
```
`ALTER TABLE` ne vraƒáa rezultate, to je OK.

**ƒåekaj, imam ideju.**
Mo≈æda je problem u `pragma`?
```rust
conn.execute("PRAGMA journal_mode=WAL;", [])?;
conn.execute("PRAGMA synchronous=NORMAL;", [])?;
```
`PRAGMA journal_mode=WAL` **VRAƒÜA REZULTAT** (string "wal").
A mi koristimo `execute`.
**BINGO.** Rusqlite se buni jer `PRAGMA journal_mode` vraƒáa redak s trenutnim modom, a mi smo rekli `execute` (oƒçekujemo 0 redaka).

**RJE≈†ENJE ZA CORE:**
Promijenit ƒáemo `execute` u `query_row` ili koristiti `pragma_update` (ako postoji) ili jednostavno ignorirati rezultat ispravno. Najlak≈°e je koristiti `query_row` i baciti rezultat.

---

### 2. Just Install Error

Error: `cp: core/target/release/valter: No such file or directory`

Razlog: Na≈°a skripta radi `cd core && cargo build --release`, ali onda poku≈°ava kopirati iz `core/target/release/valter`.
Kada si u `core` folderu i pokrene≈° build, on stavi target u `core/target`.
Ali `just` se vrti u rootu.
Komanda u Justfileu je:
```makefile
cd core && cargo build --release
cp core/target/release/valter ~/.local/bin/valter
```
Ako smo u rootu, `cd core && ...` se izvr≈°i u subshellu. Target bi trebao biti u `core/target`.
Meƒëutim, buduƒái da imamo **Workspace** (root `Cargo.toml`), Cargo mo≈æda stavlja buildove u **ROOT** `target` folder, a ne u `core/target`.

Provjeri root folder. Ima≈° li `target/release/valter`?
Vjerojatno da. Kada koristi≈° Workspaces, svi buildovi idu u zajedniƒçki `target` u rootu.

**RJE≈†ENJE ZA JUST:**
Promijeniti putanju kopiranja iz `core/target/...` u `target/...`.

---

### PLAN POPRAVKA

### POPRAVAK 1: `core/src/cloud.rs` (PRAGMA Fix)

Zamijeni metodu `new`:

<FILE_CONTENT_START ID="CLOUD_PRAGMA_FIX" PATH="core/src/cloud.rs">
    pub fn new(path: &str) -> Result<Self> {
        let conn = Connection::open(path).context("Failed to open SQLite DB")?;
        
        // FIX: PRAGMA journal_mode returns a row ("wal"), so execute() fails.
        // We use query_row to consume that result.
        let _ : String = conn.query_row("PRAGMA journal_mode=WAL", [], |row| row.get(0))
            .unwrap_or("delete".to_string());
            
        // synchronous=NORMAL doesn't return rows usually, but let's be safe via execute is fine usually,
        // but strictly speaking some pragmas do return. synchronous usually doesn't.
        conn.execute("PRAGMA synchronous=NORMAL", [])?;
        
        Ok(Self { conn: Mutex::new(conn) })
    }
</FILE_CONTENT_END>

Napomena: Mora≈° zamijeniti samo `pub fn new` unutar `impl SqliteManager`. Ostatak fajla ostaje isti. Ako ≈æeli≈° cijeli fajl za sigurnost, reci.

### POPRAVAK 2: `Justfile` (Install path fix)

A≈æuriraj `install` i `update` sekcije.

<FILE_CONTENT_START ID="JUSTFILE_FIX" PATH="Justfile">
# VALTER ERP - JUSTFILE
# Commands for Development, Installation, Maintenance, and Release.

# Default: List available commands
default:
    @just --list

# --- DEVELOPMENT ---

# Run the full stack in Dev Mode (Monorepo root)
dev:
    @echo "üöÄ Starting VALTER DEV Environment..."
    @# Run Backend in background, then Frontend. Trap SIGINT to kill backend on Ctrl+C.
    @trap 'kill %1' SIGINT; \
    (cd core && cargo run) & \
    (cd dashboard && pnpm dev)

# Clean build artifacts and temporary files
clean:
    @echo "üßπ Cleaning up..."
    rm -rf target core/target
    rm -rf dashboard/dist dashboard/.vite dashboard/node_modules
    rm -f valter.db valter.log

# --- RELEASE ---

# Create a new release (Tag & Push). Usage: just release v0.1.0
release version:
    @echo "üöÄ Preparing release {{version}}..."
    @if [ -z "{{version}}" ]; then echo "‚ùå Error: Version required. Usage: just release v0.1.0"; exit 1; fi
    @if [ -n "$(git status --porcelain)" ]; then echo "‚ùå Error: Git is dirty. Commit changes first."; exit 1; fi
    @echo "üè∑Ô∏è  Tagging version {{version}}..."
    git tag -a {{version}} -m "Release {{version}}"
    @echo "‚¨ÜÔ∏è  Pushing tag to GitHub..."
    git push origin {{version}}
    @echo "‚úÖ Done! GitHub Actions will now build and publish the release."
    @echo "   Check status here: https://github.com/Eris-Margeta/valter-25/actions"

# --- INSTALLATION (SYSTEM WIDE) ---

# Install Valter to ~/.local/bin and setup ~/.valter config
install:
    @echo "‚ö†Ô∏è  WARNING: This will overwrite ~/.valter configuration and binary."
    @echo "   Press Ctrl+C to cancel or Enter to proceed."
    @read _
    
    @echo "üì¶ Building Release Binary..."
    # Build from root workspace
    cargo build --release
    
    @echo "üìÇ Creating System Directories (~/.valter)..."
    mkdir -p ~/.valter
    mkdir -p ~/.local/bin
    
    @echo "üöö Installing Binary..."
    # FIX: Workspace puts artifacts in root target/release
    cp target/release/valter ~/.local/bin/valter
    
    @echo "üìù Installing Default Config..."
    # We copy the example config to the production path
    cp valter.config.example ~/.valter/valter.config
    
    @echo "‚úÖ Installation Complete!"
    @echo "   Run 'valter' to start the daemon."
    @echo "   (Ensure ~/.local/bin is in your PATH)"

# --- MAINTENANCE ---

# Update the binary ONLY (Preserves Data & Config)
update:
    @echo "üîÑ Updating Valter Binary..."
    cargo build --release
    cp target/release/valter ~/.local/bin/valter
    @echo "‚úÖ Binary Updated. Run 'valter' to apply migrations."

# Check for database schema changes (Dry Run - Placeholder for future CLI arg)
check-migrations:
    @echo "üîç Checking migrations..."
    @echo "Note: Currently Valter applies migrations automatically on startup."
</FILE_CONTENT_END>

---

### ≈†to sad?

1.  **Primijeni `cloud.rs` fix.** To ƒáe rije≈°iti `Execute returned results`.
2.  **Primijeni `Justfile` fix.** To ƒáe rije≈°iti `cp: No such file`.
3.  **Probaj `just dev` opet.** Dashboard bi trebao raditi (i API pozivi bi trebali prolaziti).
4.  **Probaj `just install`.** Trebalo bi proƒái glatko.
